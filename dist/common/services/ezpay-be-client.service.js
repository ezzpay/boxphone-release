"use strict";var t,e=this&&this.t||function(t,e,s,a){var i,r=arguments.length,o=3>r?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var c=t.length-1;c>=0;c--)(i=t[c])&&(o=(3>r?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o},s=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"o",{value:!0}),exports.EzpayBeClientService=void 0;const a=require("@nestjs/common"),i=require("@nestjs/axios"),r=require("rxjs"),o=require("form-data"),c=require("fs"),n=require("../constants/config"),u=require("../utils/time");let l=t=class{constructor(e){this.httpService=e,this.logger=new a.Logger(t.name),this.apiUrl=n.config.ezpayBe.apiUrl??"http://localhost:3001",this.apiKey=n.config.ezpayBe.apiKey??""}async updateWithdrawalStatus(t,e){for(let s=0;3>=s;s++)try{const a=`${this.apiUrl}/api/internal/withdrawals/complete/${t}`;this.logger.log(`Updating withdrawal ${t} status to ${e.analyzedStatus} (attempt ${s+1}/4)`);const i=new o;i.append("analyzedStatus",e.analyzedStatus),i.append("sourceAccountNo",e.sourceAccountNo),i.append("sourceBankCode",e.sourceBankCode),i.append("receipt",(0,c.createReadStream)(e.receipt));const n=await(0,r.firstValueFrom)(this.httpService.patch(a,i,{headers:{...i.getHeaders(),"X-API-Key":this.apiKey,"x-internal-secret-key":"uHqE5X9H0QEBsqlZpdTHG0fOyvmMtHjCGgsG4ouls3Gz9WvaWg4w9HV3sqETGWfE"},timeout:2e4}));if(200===n.status||204===n.status)return this.logger.log(`Successfully updated withdrawal ${t} status to ${e.analyzedStatus}`),!0;this.logger.warn(`Unexpected status code ${n.status} when updating withdrawal ${t}`)}catch(e){console.dir({message:e.message,code:e.code,details:e.errInfo?.details},{depth:10});const a=e,i=a.response?.data,r=a.message;if(s>=3)return this.logger.error(`Failed to update withdrawal ${t} after 4 attempts. Payload: ${JSON.stringify(i)}, Error: ${r}`),!1;{const e=2e3*Math.pow(2,s);this.logger.warn(`Failed to update withdrawal ${t} (attempt ${s+1}/4): ${r}. Payload: ${JSON.stringify(i)}, Retrying in ${e}ms`),await(0,u.sleep)(e)}}return!1}};exports.EzpayBeClientService=l,exports.EzpayBeClientService=l=t=e([(0,a.Injectable)(),s("design:paramtypes",[i.HttpService])],l);