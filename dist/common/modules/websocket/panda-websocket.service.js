"use strict";var e,t=this&&this.t||function(e,t,s,i){var n,c=arguments.length,r=3>c?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,s,i);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(r=(3>c?n(r):c>3?n(t,s,r):n(t,s))||r);return c>3&&r&&Object.defineProperty(t,s,r),r},s=this&&this.i||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"o",{value:!0}),exports.PandaWebSocketService=void 0;const i=require("@nestjs/common"),n=require("ws"),c=require("lodash"),r=require("../../utils/time"),o=require("../../constants/keyboard");let a=e=class{constructor(){this.logger=new i.Logger(e.name),this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=5e3,this.requestQueue=[],this.pendingRequests=new Map,this.isConnected=!1,this.isProcessingRequest=!1,this.wsUrl="ws://127.0.0.1:33333"}async onModuleInit(){await this.connect()}async onModuleDestroy(){await this.disconnect()}async connect(){return new Promise((e,t)=>{try{this.logger.log("Connecting to Panda BOX WebSocket: "+this.wsUrl),this.ws=new n(this.wsUrl),this.ws.on("open",()=>{this.logger.log("Panda BOX WebSocket connected"),this.isConnected=!0,this.reconnectAttempts=0,this.processRequestQueue(),e()}),this.ws.on("message",e=>{try{const t=e.toString(),s=JSON.parse(t);this.handleMessage(s)}catch(t){this.logger.error("Error parsing WebSocket message: "+t.message,t.stack),this.logger.error("Raw message was: "+e.toString())}}),this.ws.on("error",e=>{this.logger.error("WebSocket error: "+e.message),this.isConnected=!1,0===this.reconnectAttempts&&t(e)}),this.ws.on("close",()=>{this.logger.warn("Panda BOX WebSocket closed"),this.isConnected=!1,this.scheduleReconnect()})}catch(e){this.logger.error("Error creating WebSocket connection: "+e.message),t(e)}})}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return this.logger.error("Max reconnection attempts reached"),void 0;this.reconnectAttempts++;const e=this.reconnectDelay*this.reconnectAttempts;this.logger.log(`Scheduling reconnect attempt ${this.reconnectAttempts} in ${e}ms`),setTimeout(()=>{this.connect().catch(e=>{this.logger.error("Reconnection failed: "+e.message)})},e)}async disconnect(){this.ws&&(this.ws.close(),this.ws=null,this.isConnected=!1)}handleMessage(e){if(this.pendingRequests.size>0){const[t,s]=this.pendingRequests.entries().next().value;if(this.pendingRequests.delete(t),1e4===e.code)s.resolve(e.data);else{const t=e.message||"Panda BOX error: "+e.code;s.reject(Error(t))}}else if(Array.isArray(e.data)&&e.data.length>0&&void 0!==e.data[0]?.serial&&1e4===e.code){const t=e.data;this.logger.debug(`Received unsolicited device list update (no pending requests): ${t.length} device(s)`)}else this.logger.warn("Received response but no pending requests: "+JSON.stringify(e))}async processRequestQueue(){if(this.isProcessingRequest||0===this.requestQueue.length)return;if(!this.isConnected||!this.ws)return;this.isProcessingRequest=!0;const{request:e,resolve:t,reject:s,timeout:i}=this.requestQueue.shift();try{t(await this.h(e,i))}catch(e){s(e)}finally{this.isProcessingRequest=!1,this.requestQueue.length>0&&setImmediate(()=>this.processRequestQueue())}}async h(e,t=3e4){return new Promise((s,i)=>{const n=Date.now().toString()+Math.random().toString(36).substr(2,9);this.pendingRequests.set(n,{resolve:s,reject:i});const c=setTimeout(()=>{this.pendingRequests.delete(n),i(Error("WebSocket request timeout"))},t),r=s,o=i;s=e=>{clearTimeout(c),r(e)},i=e=>{clearTimeout(c),o(e)},this.pendingRequests.set(n,{resolve:s,reject:i});try{const t=JSON.stringify(e);this.ws.send(t)}catch(e){this.logger.error("Error sending WebSocket request: "+e.message,e.stack),this.pendingRequests.delete(n),clearTimeout(c),i(e)}})}async sendRequest(e,t=3e4){return new Promise((s,i)=>{this.requestQueue.push({request:e,resolve:s,reject:i,timeout:t}),this.processRequestQueue()})}async listDevices(){this.logger.log("Requesting device list...");const e=await this.sendRequest({action:"list"}),t=e.map(e=>({...e,udid:e.serial}));return this.logger.log("Device list response received: "+JSON.stringify(e)),t}async click(e,t,s,i=.2){return this.sendRequest({action:"pointerEvent",devices:Array.isArray(e)?e.join(","):e,data:{type:"10",x:(0,c.toString)(t),y:(0,c.toString)(s)}})}async swipe(e,t){const s=Array.isArray(e)?e.join(","):e;return this.sendRequest({action:"pointerEvent",devices:s,data:t})}async captureScreen(e,t){return this.sendRequest({action:"screenFile",devices:e,data:{savePath:t.folderPath}})}async home(e){return this.sendRequest({action:"pushEvent",devices:e,data:{type:"2"}})}async launchApp(e,t){const s=Array.isArray(e)?e.join(","):e;return this.sendRequest({action:"startApp",devices:s,data:{app:t}})}async killApp(e,t){const s=Array.isArray(e)?e.join(","):e;return this.sendRequest({action:"stopApp",devices:s,data:{app:t}})}async switchKeyboardMode(e){const{x:t,y:s}=o.COMMON_COORDINATES.KEYBOARD_SWITCH;this.logger.log(`Switching keyboard mode on device ${e} at coordinates (${t}, ${s})`),await this.click(e,100*t,100*s,.2),await(0,r.sleep)(500),this.logger.log("Keyboard mode switched successfully on device "+e)}async pressShiftKey(e){const{x:t,y:s}=o.COMMON_COORDINATES.SHIFT_KEY;this.logger.debug(`Pressing shift key on device ${e} at coordinates (${t}, ${s})`),await this.click(e,100*t,100*s,.2),await(0,r.sleep)(200),this.logger.debug("Shift key pressed successfully on device "+e)}async pressReturnKey(e){const{x:t,y:s}=o.COMMON_COORDINATES.RETURN_KEY;this.logger.log(`Pressing return key on device ${e} at coordinates (${t}, ${s})`),await this.click(e,100*t,100*s,.2),await(0,r.sleep)(500),this.logger.log("Return key pressed successfully on device "+e)}async inputText(e,t){const s=Array.isArray(e)?e.join(","):e;return this.sendRequest({action:"inputText",devices:s,data:{content:t}})}async inputNumpadNumber(e,t){if(!t||0===t.length)throw Error("value cannot be empty");for(let s=0;s<t.length;s++){const i=t[s],n=o.NUMPAD_LAYOUT[i];await this.click(e,n.x,n.y),this.logger.debug(`Clicking key '${i}' at (${n.x}, ${n.y})`),await(0,r.sleep)(200)}}};exports.PandaWebSocketService=a,exports.PandaWebSocketService=a=e=t([(0,i.Injectable)(),s("design:paramtypes",[])],a);