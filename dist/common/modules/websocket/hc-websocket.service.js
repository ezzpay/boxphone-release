"use strict";var t,e=this&&this.t||function(t,e,s,i){var r,n=arguments.length,c=3>n?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,s,i);else for(var o=t.length-1;o>=0;o--)(r=t[o])&&(c=(3>n?r(c):n>3?r(e,s,c):r(e,s))||c);return n>3&&c&&Object.defineProperty(e,s,c),c},s=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"o",{value:!0}),exports.HCWebSocketService=void 0;const i=require("@nestjs/common"),r=require("ws"),n=require("../../constants/keyboard"),c=require("../../utils/time"),o=require("lodash");let h=t=class{constructor(){this.logger=new i.Logger(t.name),this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=10,this.reconnectDelay=5e3,this.requestQueue=[],this.pendingRequests=new Map,this.isConnected=!1,this.isProcessingRequest=!1,this.wsUrl="ws://127.0.0.1:26608"}async onModuleInit(){await this.connect()}async onModuleDestroy(){await this.disconnect()}async connect(){return new Promise((t,e)=>{try{this.logger.log("Connecting to HC BOX WebSocket: "+this.wsUrl),this.ws=new r(this.wsUrl),this.ws.on("open",()=>{this.logger.log("HC BOX WebSocket connected"),this.isConnected=!0,this.reconnectAttempts=0,this.processRequestQueue(),t()}),this.ws.on("message",t=>{try{const e=JSON.parse(t.toString());this.handleMessage(e)}catch(t){this.logger.error("Error parsing WebSocket message: "+t.message)}}),this.ws.on("error",t=>{this.logger.error("WebSocket error: "+t.message),this.isConnected=!1,0===this.reconnectAttempts&&e(t)}),this.ws.on("close",()=>{this.logger.warn("HC BOX WebSocket closed"),this.isConnected=!1,this.scheduleReconnect()})}catch(t){this.logger.error("Error creating WebSocket connection: "+t.message),e(t)}})}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return this.logger.error("Max reconnection attempts reached"),void 0;this.reconnectAttempts++;const t=this.reconnectDelay*this.reconnectAttempts;this.logger.log(`Scheduling reconnect attempt ${this.reconnectAttempts} in ${t}ms`),setTimeout(()=>{this.connect().catch(t=>{this.logger.error("Reconnection failed: "+t.message)})},t)}async disconnect(){this.ws&&(this.ws.close(),this.ws=null,this.isConnected=!1)}handleMessage(t){if(this.pendingRequests.size>0){const[e,s]=this.pendingRequests.entries().next().value;this.pendingRequests.delete(e),200===t.StatusCode?s.resolve(t.result):s.reject(Error("HC BOX error: "+t.StatusCode))}else this.logger.warn("Received response but no pending requests: "+JSON.stringify(t))}async processRequestQueue(){if(this.isProcessingRequest||0===this.requestQueue.length)return;if(!this.isConnected||!this.ws)return;this.isProcessingRequest=!0;const{request:t,resolve:e,reject:s,timeout:i}=this.requestQueue.shift();try{e(await this.h(t,i))}catch(t){s(t)}finally{this.isProcessingRequest=!1,this.requestQueue.length>0&&setImmediate(()=>this.processRequestQueue())}}async h(t,e=3e4){return new Promise((s,i)=>{const r=Date.now().toString()+Math.random().toString(36).substr(2,9);this.pendingRequests.set(r,{resolve:s,reject:i});const n=setTimeout(()=>{this.pendingRequests.delete(r),i(Error("WebSocket request timeout"))},e),c=s,o=i;s=t=>{clearTimeout(n),c(t)},i=t=>{clearTimeout(n),o(t)},this.pendingRequests.set(r,{resolve:s,reject:i});try{this.ws.send(JSON.stringify(t))}catch(t){this.pendingRequests.delete(r),clearTimeout(n),i(t)}})}async sendRequest(t,e=3e4){return new Promise((s,i)=>{this.requestQueue.push({request:t,resolve:s,reject:i,timeout:e}),this.processRequestQueue()})}async listDevices(){const t=await this.sendRequest({action:"list"});return Array.isArray(t)?t:[]}async click(t,e,s,i=.2){const r=Array.isArray(t)?t.join(","):t;return this.sendRequest({action:"click",comm:{deviceIds:r,x:e,y:s,duration:i}})}async swipe(t,e){const s=Array.isArray(t)?t.join(","):t;return this.sendRequest({action:"swipe",comm:{deviceIds:s,...e}})}async captureScreen(t,e){return this.sendRequest({action:"screen",comm:{deviceIds:t,...(0,o.omit)(e,"folderPath"),filePath:e.folderPath}})}async home(t){const e=Array.isArray(t)?t.join(","):t;return this.sendRequest({action:"home",comm:{deviceIds:e}})}async launchApp(t,e){const s=Array.isArray(t)?t.join(","):t;return this.sendRequest({action:"launchApp",comm:{deviceIds:s,content:e}})}async killApp(t,e){const s=Array.isArray(t)?t.join(","):t;return this.sendRequest({action:"killApp",comm:{deviceIds:s,content:e}})}isNumber(t){return/^[0-9]$/.test(t)}isLetter(t){return/^[a-zA-Z]$/.test(t)}isSpecialCharInNumberMode(t){return["@","!"].includes(t)}async switchKeyboardMode(t){const{x:e,y:s}=n.COMMON_COORDINATES.KEYBOARD_SWITCH;this.logger.log(`Switching keyboard mode on device ${t} at coordinates (${e}, ${s})`),await this.click(t,e,s,.2),await(0,c.sleep)(500),this.logger.log("Keyboard mode switched successfully on device "+t)}async pressShiftKey(t){const{x:e,y:s}=n.COMMON_COORDINATES.SHIFT_KEY;this.logger.debug(`Pressing shift key on device ${t} at coordinates (${e}, ${s})`),await this.click(t,e,s,.2),await(0,c.sleep)(200),this.logger.debug("Shift key pressed successfully on device "+t)}async pressReturnKey(t){const{x:e,y:s}=n.COMMON_COORDINATES.RETURN_KEY;this.logger.log(`Pressing return key on device ${t} at coordinates (${e}, ${s})`),await this.click(t,e,s,.2),await(0,c.sleep)(500),this.logger.log("Return key pressed successfully on device "+t)}async inputText(t,e){if(!e||0===e.length)throw Error("Password cannot be empty");let s="letter";for(let i=0;i<e.length;i++){const r=e[i],o=r.toLowerCase(),h=r!==o&&this.isLetter(r),a=this.isSpecialCharInNumberMode(r)?r:o,u=n.KEYBOARD_LAYOUT[a];if(!u){this.logger.warn(`Character '${r}' not found in keyboard layout. Skipping...`);continue}let l=null;this.isNumber(o)?l="number":this.isLetter(o)?l="letter":this.isSpecialCharInNumberMode(r)&&(l="number"),l&&s!==l&&(this.logger.debug(`Switching keyboard to ${l} mode for character '${r}'`),await this.switchKeyboardMode(t),s=l),h&&"letter"===s&&(this.logger.debug(`Pressing shift key for uppercase letter '${r}'`),await this.pressShiftKey(t)),this.logger.debug(`Clicking key '${a}'${h?" (uppercase)":""} at (${u.x}, ${u.y})`),await this.click(t,u.x,u.y,.15),await(0,c.sleep)(200)}this.logger.log("Text input completed on device "+t)}async inputNumpadNumber(t,e){if(!e||0===e.length)throw Error("value cannot be empty");for(let s=0;s<e.length;s++){const i=e[s],r=n.NUMPAD_LAYOUT[i];await this.click(t,r.x,r.y,.15),this.logger.debug(`Clicking key '${i}' at (${r.x}, ${r.y})`),await(0,c.sleep)(200)}}};exports.HCWebSocketService=h,exports.HCWebSocketService=h=t=e([(0,i.Injectable)(),s("design:paramtypes",[])],h);