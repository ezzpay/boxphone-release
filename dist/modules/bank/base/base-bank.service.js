"use strict";var t,e=this&&this.t||function(t,e,i,s){var a,r=arguments.length,n=3>r?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var c=t.length-1;c>=0;c--)(a=t[c])&&(n=(3>r?a(n):r>3?a(e,i,n):a(e,i))||n);return r>3&&n&&Object.defineProperty(e,i,n),n},i=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},s=this&&this.o||function(t,e){return function(i,s){e(i,s,t)}};Object.defineProperty(exports,"l",{value:!0}),exports.BaseBankService=void 0;const a=require("@nestjs/common"),r=require("../../device/device.service"),n=require("../../../common/modules/websocket/constants/websocket"),c=require("../../../common/utils/time"),o=require("fs"),l=require("fs/promises"),h=require("path"),u=require("../constants/bill"),$=require("../../ocr/ocr");let p=t=class{constructor(e,i){this.wsService=e,this.deviceService=i,this.baseTransactionFolderPath="C:/EzpData",this.logger=new a.Logger(this.constructor.name),t.createTransactionFolder(this.baseTransactionFolderPath,this.logger)}static createTransactionFolder(e,i){if(!t.folderCreated){if(t.folderCreationInProgress){let i=0;const s=10;for(;t.folderCreationInProgress&&s>i;){i++;const t=Date.now();for(;10>Date.now()-t;);}if(t.folderCreated||(0,o.existsSync)(e))return t.folderCreated=!0,void 0}try{t.folderCreationInProgress=!0,(0,o.existsSync)(e)?i.debug("Base folder already exists: "+e):((0,o.mkdirSync)(e,{recursive:!0}),i.log("Created base folder: "+e)),t.folderCreated=!0}catch(s){"EEXIST"!==s.code?i.error(`Failed to create base folder ${e}: ${s.message}`):(t.folderCreated=!0,i.debug("Base folder already exists (created by another process): "+e))}finally{t.folderCreationInProgress=!1}}}getBankCode(){return this.BANK_CODE}async launchApp(t,e=3){for(let i=1;e>=i;i++)try{return 1===i?this.logger.log(`Launching ${this.BANK_CODE} app on device ${t}`):this.logger.log(`Retrying launch ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e})`),await this.wsService.launchApp(t,this.BUNDLE_ID),await(0,c.sleep)(1e4),i>1?this.logger.log(`${this.BANK_CODE} app launched successfully on device ${t} after ${i} attempt(s)`):this.logger.log(`${this.BANK_CODE} app launched successfully on device ${t}`),void 0}catch(s){if(!(s instanceof Error&&s.message.includes("timeout")))throw this.logger.error(`Error launching ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e}): ${s.message}`),s;if(i>=e)throw this.logger.error(`Error launching ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e}): ${s.message}`),s;{const s=1e3*Math.pow(2,i);this.logger.warn(`WebSocket timeout when launching ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e}). Retrying in ${s}ms...`),await(0,c.sleep)(s)}}}async killApp(t,e=2){for(let i=1;e>=i;i++)try{return 1===i?this.logger.log(`Killing ${this.BANK_CODE} app on device ${t}`):this.logger.log(`Retrying kill ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e})`),await this.wsService.killApp(t,this.BUNDLE_ID),await(0,c.sleep)(3e3),i>1?this.logger.log(`${this.BANK_CODE} app killed successfully on device ${t} after ${i} attempt(s)`):this.logger.log(`${this.BANK_CODE} app killed successfully on device ${t}`),void 0}catch(s){if(!(s instanceof Error&&s.message.includes("timeout")))throw this.logger.error(`Error killing ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e}): ${s.message}`),s;if(i>=e)throw this.logger.error(`Error killing ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e}): ${s.message}`),s;{const s=1e3*Math.pow(2,i-1);this.logger.warn(`WebSocket timeout when killing ${this.BANK_CODE} app on device ${t} (attempt ${i}/${e}). Retrying in ${s}ms...`),await(0,c.sleep)(s)}}}async clickWithTransition(t,e,i,s,a=""){await this.wsService.click(t,e,i,.2),a&&this.logger.log(a),await(0,c.sleep)(s)}async captureScreen(t,e){this.logger.log(`Capturing screen on device ${t} with folderPath: ${e.folderPath}`);const i=`${this.baseTransactionFolderPath}/${e.folderPath}`;await(0,l.mkdir)(i,{recursive:!0}),await(0,c.sleep)(1e3),await this.wsService.captureScreen(t,{...e,folderPath:i}),await(0,c.sleep)(5e3)}async getBillImage(t){try{const e=(0,h.join)(this.baseTransactionFolderPath,t),i=(await(0,l.readdir)(e))[0];if(!i)return this.logger.warn("No image file found in folder: "+t),null;const s=(0,h.join)(e,i),a=(await(0,l.readFile)(s)).toString("base64"),r=i.toLowerCase().substring(i.lastIndexOf("."));return`data:${(0,u.getMimeType)(r)};base64,${a}`}catch(e){throw this.logger.error(`Error loading image from folder ${t}: ${e.message}`),e}}async analyzeTransferBill(t){const e=Date.now(),i=await this.getBillImage(t.withdrawalCode);if(!i)return{raw:null,analyzedStatus:"unknown",success:!1};const s=await(0,$.ocrBill)(i),a=(0,$.analyzeBill)(s.parsedText),r=Date.now();return console.log(`Analyze transfer bill time: ${r-e}ms`),{raw:i,analyzedStatus:a.analyzedStatus,success:a.success}}};exports.BaseBankService=p,p.folderCreationInProgress=!1,p.folderCreated=!1,exports.BaseBankService=p=t=e([(0,a.Injectable)(),s(0,(0,a.Inject)(n.WEBSOCKET_SERVICE)),i("design:paramtypes",[Object,r.DeviceService])],p);