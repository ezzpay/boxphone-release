"use strict";var e,t=this&&this.t||function(e,t,s,n){var i,r=arguments.length,a=3>r?t:null===n?n=Object.getOwnPropertyDescriptor(t,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,s,n);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(a=(3>r?i(a):r>3?i(t,s,a):i(t,s))||a);return r>3&&a&&Object.defineProperty(t,s,a),a},s=this&&this.i||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.o||function(e,t){return function(s,n){t(s,n,e)}};Object.defineProperty(exports,"u",{value:!0}),exports.BankController=void 0;const i=require("@nestjs/common"),r=require("@nestjs/swagger"),a=require("./bank.service"),c=require("../hcbox/hcbox.service"),d=require("../../common/constants/config"),o=require("../../common/modules/websocket/constants/websocket");let u=e=class{constructor(t,s,n){this.bankService=t,this.hcBoxService=s,this.wsService=n,this.logger=new i.Logger(e.name)}getBankService(e){const t=this.bankService.getBankService(e);if(!t)throw new i.HttpException({success:!1,error:`Bank service not found for bank code: ${e}. Supported banks: ${this.bankService.getSupportedBanks().join(", ")}`},i.HttpStatus.BAD_REQUEST);return t}async getDevices(e){try{return{success:!0,data:await this.hcBoxService.listDevices()}}catch(e){return this.logger.error("Error getting devices: "+e.message),{success:!1,error:e.message}}}async testLaunchApp(e,t){try{const s=this.getBankService(e);return this.logger.log(`Testing ${e} app launch on device: ${t}`),await s.launchApp(t),{success:!0,message:`${e} app launched successfully on device ${t}`}}catch(t){return this.logger.error(`Error testing ${e} app launch: ${t.message}`),{success:!1,error:t.message}}}async testCaptureScreen(e,t,s,n){try{this.getBankService(e),this.logger.log("Testing screen capture on device: "+t);const i=n?parseFloat(n):.5,r=s||"test-screen-capture-"+Date.now(),a=await this.wsService.captureScreen(t,{quality:i,folderPath:`C:/boxscreen/${r}.png`});return{success:!0,message:"Screen captured successfully on device "+t,data:{base64Image:a,imageLength:a?.length??0}}}catch(e){return this.logger.error("Error testing screen capture: "+e.message),{success:!1,error:e.message}}}async testClickAtCoordinates(e,t,s,n){try{const i=parseFloat(s),r=parseFloat(n);return isNaN(i)||isNaN(r)?{success:!1,error:"Invalid coordinates. x and y must be numbers between 0 and 1",example:`/api/bank/${e}/test/click/{deviceId}?x=0.5&y=0.55`}:(this.logger.log(`Testing click at coordinates (${i}, ${r}) on device: ${t}`),await this.wsService.click(t,i,r),{success:!0,message:`Click completed successfully at coordinates (${i}, ${r}) on device ${t}`,coordinates:{x:i,y:r}})}catch(e){return this.logger.error("Error testing click at coordinates: "+e.message),{success:!1,error:e.message}}}async testSwipe(e,t,s,n,i,r,a,c){try{this.getBankService(e);const o="PANDA"===d.config.boxType,u="HC"===d.config.boxType;if(o){if(!i)return{success:!1,error:"For Panda format: type is required",example:`/api/bank/${e}/test/swipe/{deviceId}?type=0`};if(!["0","1","2","4","5","6","7","8","9","10"].includes(i))return{success:!1,error:"Invalid type. Type must be one of: 0 (按下/press), 1 (抬起/lift), 2 (移动/move), 4 (滚轮向上/scroll up), 5 (滚轮向下/scroll down), 6 (上滑/swipe up), 7 (下滑/swipe down), 8 (左滑/swipe left), 9 (右滑/swipe right), 10 (点击/click)",example:`/api/bank/${e}/test/swipe/{deviceId}?type=0`};if(!(["4","5","6","7","8","9"].includes(i)||s&&n))return{success:!1,error:`For Panda type ${i}: x and y are required`,example:`/api/bank/${e}/test/swipe/{deviceId}?x=50&y=30&type=${i}`};const r={type:i};if(s&&n){const t=parseFloat(s),a=parseFloat(n);if(isNaN(t)||isNaN(a))return{success:!1,error:"Invalid coordinates. x and y must be numbers between 0 and 100 for Panda",example:`/api/bank/${e}/test/swipe/{deviceId}?x=50&y=30&type=${i}`};if(0>t||t>100||0>a||a>100)return{success:!1,error:"Invalid coordinates. x and y must be between 0 and 100 for Panda",example:`/api/bank/${e}/test/swipe/{deviceId}?x=50&y=30&type=${i}`};r.x=t.toString(),r.y=a.toString()}return this.logger.log(`Testing Panda swipe on device: ${t} with type=${i}${s&&n?`, x=${s}, y=${n}`:" (swipe direction, no coordinates)"}`),await this.wsService.swipe(t,r),{success:!0,message:"Panda swipe completed successfully on device "+t,coordinates:{type:i,...s&&n?{x:s,y:n}:{}}}}if(u){if(!(s&&n&&r&&a))return{success:!1,error:"For HC format: x, y, endX, and endY are required",example:`/api/bank/${e}/test/swipe/{deviceId}?x=0.2&y=0.5&endX=0.8&endY=0.5&duration=0.3`};const i=parseFloat(s),d=parseFloat(n),o=parseFloat(r),u=parseFloat(a),p=c?parseFloat(c):.2;return isNaN(i)||isNaN(d)||isNaN(o)||isNaN(u)?{success:!1,error:"Invalid coordinates. x, y, endX, and endY must be numbers between 0 and 1 for HC",example:`/api/bank/${e}/test/swipe/{deviceId}?x=0.2&y=0.5&endX=0.8&endY=0.5&duration=0.3`}:0>i||i>1||0>d||d>1||0>o||o>1||0>u||u>1?{success:!1,error:"Invalid coordinates. x, y, endX, and endY must be between 0 and 1 for HC",example:`/api/bank/${e}/test/swipe/{deviceId}?x=0.2&y=0.5&endX=0.8&endY=0.5&duration=0.3`}:(this.logger.log(`Testing HC swipe from (${i}, ${d}) to (${o}, ${u}) on device: ${t}`),await this.wsService.swipe(t,{x:i,y:d,endX:o,endY:u,duration:p}),{success:!0,message:`HC swipe completed successfully from (${i}, ${d}) to (${o}, ${u}) on device ${t}`,coordinates:{start:{x:i,y:d},end:{x:o,y:u},duration:p}})}return{success:!1,error:`Invalid box type configuration: ${d.config.boxType}. Must be 'HC' or 'PANDA'`}}catch(e){return this.logger.error("Error testing swipe: "+e.message),{success:!1,error:e.message}}}async testInputNumpadNumber(e,t,s){try{return this.getBankService(e),s&&0!==s.trim().length?/^\d+$/.test(s)?(this.logger.log(`Testing numpad number input "${s}" on device: ${t}`),await this.hcBoxService.inputNumpadNumber(t,s),{success:!0,message:"Numpad number input completed successfully on device "+t,data:{number:s,digits:s.split("").map(e=>parseInt(e))}}):{success:!1,error:"Number must contain only digits (0-9)",example:`/api/bank/${e}/test/input-numpad/{deviceId}?number=123456`}:{success:!1,error:"Number is required and cannot be empty",example:`/api/bank/${e}/test/input-numpad/{deviceId}?number=123456`}}catch(e){return this.logger.error("Error testing numpad number input: "+e.message),{success:!1,error:e.message}}}async testInputText(e,t,s){try{return this.getBankService(e),s&&0!==s.trim().length?(this.logger.log(`Testing text input "${s}" on device: ${t}`),await this.hcBoxService.inputText(t,s),{success:!0,message:"Text input completed successfully on device "+t}):{success:!1,error:"Text is required and cannot be empty",example:`/api/bank/${e}/test/input-text/{deviceId}?text=abc123`}}catch(e){return this.logger.error("Error testing text input: "+e.message),{success:!1,error:e.message}}}async testPressReturn(e,t){try{return this.getBankService(e),this.logger.log("Testing press return key on device: "+t),await this.wsService.pressReturnKey(t),{success:!0,message:"Return key pressed successfully on device "+t,note:"This key can dismiss keyboard or submit/enter depending on context"}}catch(e){return this.logger.error("Error testing press return: "+e.message),{success:!1,error:e.message}}}};exports.BankController=u,t([(0,i.Get)("devices"),(0,r.ApiOperation)({summary:"Get list of available devices"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiResponse)({status:200,description:"List of devices retrieved successfully"}),n(0,(0,i.Param)("bankCode")),s("design:type",Function),s("design:paramtypes",[String]),s("design:returntype",Promise)],u.prototype,"getDevices",null),t([(0,i.Post)("test/launch-app/:deviceId"),(0,r.ApiOperation)({summary:"Test launching bank app on a device"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiResponse)({status:200,description:"App launched successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),s("design:type",Function),s("design:paramtypes",[String,String]),s("design:returntype",Promise)],u.prototype,"testLaunchApp",null),t([(0,i.Post)("test/capture-screen/:deviceId"),(0,r.ApiOperation)({summary:"Test screen capture on a device"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiQuery)({name:"name",description:"Screen capture name (optional)",required:!1}),(0,r.ApiQuery)({name:"quality",description:"Image quality (0-1, default: 0.5)",required:!1}),(0,r.ApiResponse)({status:200,description:"Screen captured successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),n(2,(0,i.Query)("name")),n(3,(0,i.Query)("quality")),s("design:type",Function),s("design:paramtypes",[String,String,String,String]),s("design:returntype",Promise)],u.prototype,"testCaptureScreen",null),t([(0,i.Post)("test/click/:deviceId"),(0,r.ApiOperation)({summary:"Test clicking at specific coordinates on a device"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiQuery)({name:"x",description:"X coordinate (HC: 0-1, Panda: 0-100)",required:!0}),(0,r.ApiQuery)({name:"y",description:"Y coordinate (Hc: 0-1), Panda: 0-100",required:!0}),(0,r.ApiResponse)({status:200,description:"Click completed successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),n(2,(0,i.Query)("x")),n(3,(0,i.Query)("y")),s("design:type",Function),s("design:paramtypes",[String,String,String,String]),s("design:returntype",Promise)],u.prototype,"testClickAtCoordinates",null),t([(0,i.Post)("test/swipe/:deviceId"),(0,r.ApiOperation)({summary:"Test swiping on a device. Format is determined by config.boxType (HC or PANDA)"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiQuery)({name:"x",description:"X coordinate (HC: 0-1, Panda: 0-100). Required for HC and Panda types 0,1,2,10. Optional for Panda types 4,5,6,7,8,9",required:!1}),(0,r.ApiQuery)({name:"y",description:"Y coordinate (HC: 0-1, Panda: 0-100). Required for HC and Panda types 0,1,2,10. Optional for Panda types 4,5,6,7,8,9",required:!1}),(0,r.ApiQuery)({name:"type",description:"Panda pointer event type: 0=按下(press), 1=抬起(lift), 2=移动(move), 4=滚轮向上(scroll up), 5=滚轮向下(scroll down), 6=上滑(swipe up), 7=下滑(swipe down), 8=左滑(swipe left), 9=右滑(swipe right), 10=点击(click). Required for Panda format.",required:!1}),(0,r.ApiQuery)({name:"endX",description:"End X coordinate for HC (required for HC: 0-1)",required:!1}),(0,r.ApiQuery)({name:"endY",description:"End Y coordinate for HC (required for HC: 0-1)",required:!1}),(0,r.ApiQuery)({name:"duration",description:"Swipe duration for HC (default: 0.2)",required:!1}),(0,r.ApiResponse)({status:200,description:"Swipe completed successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),n(2,(0,i.Query)("x")),n(3,(0,i.Query)("y")),n(4,(0,i.Query)("type")),n(5,(0,i.Query)("endX")),n(6,(0,i.Query)("endY")),n(7,(0,i.Query)("duration")),s("design:type",Function),s("design:paramtypes",[String,String,String,String,String,String,String,String]),s("design:returntype",Promise)],u.prototype,"testSwipe",null),t([(0,i.Post)("test/input-numpad/:deviceId"),(0,r.ApiOperation)({summary:"Test inputting number using numpad layout on a device"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiQuery)({name:"number",description:'Number string to input (e.g., "123", "456789")',required:!0}),(0,r.ApiResponse)({status:200,description:"Numpad number input completed successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),n(2,(0,i.Query)("number")),s("design:type",Function),s("design:paramtypes",[String,String,String]),s("design:returntype",Promise)],u.prototype,"testInputNumpadNumber",null),t([(0,i.Post)("test/input-text/:deviceId"),(0,r.ApiOperation)({summary:"Test inputting text using keyboard layout on a device"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiQuery)({name:"text",description:'Text string to input (e.g., "abc123", "test@email.com")',required:!0}),(0,r.ApiResponse)({status:200,description:"Text input completed successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),n(2,(0,i.Query)("text")),s("design:type",Function),s("design:paramtypes",[String,String,String]),s("design:returntype",Promise)],u.prototype,"testInputText",null),t([(0,i.Post)("test/press-return/:deviceId"),(0,r.ApiOperation)({summary:"Test pressing return key on a device"}),(0,r.ApiParam)({name:"bankCode",description:"Bank code (ACB, PGBANK, etc.)"}),(0,r.ApiParam)({name:"deviceId",description:"Device ID"}),(0,r.ApiResponse)({status:200,description:"Return key pressed successfully"}),n(0,(0,i.Param)("bankCode")),n(1,(0,i.Param)("deviceId")),s("design:type",Function),s("design:paramtypes",[String,String]),s("design:returntype",Promise)],u.prototype,"testPressReturn",null),exports.BankController=u=e=t([(0,r.ApiTags)("bank"),(0,i.Controller)("api/bank/:bankCode"),n(2,(0,i.Inject)(o.WEBSOCKET_SERVICE)),s("design:paramtypes",[a.BankService,c.HcBoxService,Object])],u);