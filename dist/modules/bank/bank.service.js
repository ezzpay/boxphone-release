"use strict";var e,t=this&&this.t||function(e,t,i,s){var r,n=arguments.length,o=3>n?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(3>n?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},i=this&&this.i||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"o",{value:!0}),exports.BankService=void 0;const s=require("@nestjs/common"),r=require("./acb.service"),n=require("./pg.service"),o=require("../device/device.service"),a=require("../hcbox/hcbox.service"),c=require("./session-management.service"),h=require("../device/device-lock.service");let l=e=class{constructor(t,i,r,n,o,a){this.acbService=t,this.pgService=i,this.deviceService=r,this.hcBoxService=n,this.sessionManagement=o,this.deviceLock=a,this.logger=new s.Logger(e.name),this.bankServices=new Map,this.registerBankService(this.acbService),this.registerBankService(this.pgService)}registerBankService(e){const t=e.getBankCode().toUpperCase();this.bankServices.set(t,e),this.logger.log("Registered bank service: "+t)}getBankService(e){const t=this.bankServices.get(e.toUpperCase());return t||this.logger.warn("Bank service not found for bank code: "+e),t||null}getSupportedBanks(){return Array.from(this.bankServices.keys())}async login(e,t,i=!1){if(await this.deviceLock.isLocked(t)&&!i){const e=await this.deviceLock.getLock(t);throw Error(`Device ${t} is currently locked by ${e?.lockType} (${e?.lockedBy}). Cannot login.`)}const s=`login:${e}:${t}:${Date.now()}`;if(!await this.deviceLock.acquireLock(t,"login",s,3e5))throw Error("Failed to acquire lock for device "+t);try{await this.sessionManagement.markLoggingIn(t,e);const i=this.getBankService(e);if(!i)throw Error("Bank service not found for bank code: "+e);this.logger.log(`Logging in to ${e} on device ${t}`),await i.login(t),await this.sessionManagement.recordLogin(t,e),this.logger.log(`Successfully logged in to ${e} on device ${t}`)}catch(i){throw await this.sessionManagement.clearSession(t,e),i}finally{await this.deviceLock.releaseLock(t)}}async loginAllActiveBanks(){try{const e=(await this.deviceService.listDevices()).filter(e=>"active"===e.status&&e.bankCode);if(0===e.length)return this.logger.warn("No active devices found to login"),void 0;this.logger.log(`Logging in to ${e.length} active device(s)`);for(const t of e){const e=t.udid;try{await this.deviceLock.releaseLockByType(e,"transfer")}catch(t){this.logger.warn(`Failed to release transfer lock for device ${e}: ${t.message}`)}}const t=[];for(const i of e){const e=i.bankCode.toUpperCase(),s=i.udid;t.push(this.login(e,s,!0).catch(t=>{this.logger.error(`Failed to login ${e} on device ${s}: ${t.message}`)}))}await Promise.allSettled(t),this.logger.log("Completed login process for all active banks")}catch(e){throw this.logger.error("Error logging in all active banks: "+e.message),e}}executeTransfer(e,t,i){return this.getBankService(i).executeTransfer(e,t)}async isSessionValid(e,t){return await this.sessionManagement.isSessionValid(e,t)}async getBillImage(e,t){const i=this.getBankService(e);return i?await i.getBillImage(t):(this.logger.warn(`Bank ${e} not supported, cannot get bill image`),null)}async analyzeTransferBill(e,t){const i=this.getBankService(e);return i?await i.analyzeTransferBill(t):(this.logger.warn(`Bank ${e} not supported, cannot analyze transfer bill`),null)}async refreshSessionIfNeeded(e,t){const i=await this.sessionManagement.getSession(e,t);if("logging_in"===i?.status)return!1;const s=await this.sessionManagement.needsRefresh(e,t),r=await this.sessionManagement.isSessionValid(e,t);if(!s&&r)return!1;if(await this.deviceLock.isLocked(e))return this.logger.warn(`Cannot refresh session for device ${e} - device is locked`),!1;try{return r?this.logger.log(`Refreshing session for device ${e}, bank ${t}`):this.logger.log(`Session expired or missing for device ${e}, bank ${t}. Retrying login...`),await this.login(t,e),!0}catch(t){return this.logger.error(`Failed to refresh session for device ${e}: ${t.message}`),!1}}};exports.BankService=l,exports.BankService=l=e=t([(0,s.Injectable)(),i("design:paramtypes",[r.AcbService,n.PgService,o.DeviceService,a.HcBoxService,c.SessionManagementService,h.DeviceLockService])],l);