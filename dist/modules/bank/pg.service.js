"use strict";var t=this&&this.t||function(t,i,e,a){var n,o=arguments.length,r=3>o?i:null===a?a=Object.getOwnPropertyDescriptor(i,e):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,i,e,a);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(r=(3>o?n(r):o>3?n(i,e,r):n(i,e))||r);return o>3&&r&&Object.defineProperty(i,e,r),r},i=this&&this.i||function(t,i){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,i)},e=this&&this.o||function(t,i){return function(e,a){i(e,a,t)}};Object.defineProperty(exports,"h",{value:!0}),exports.PgService=void 0;const a=require("@nestjs/common"),n=require("../device/device.service"),o=require("./base/base-bank.service"),r=require("../../common/modules/websocket/constants/websocket"),s=require("../../common/utils/time"),c=require("./constants/pgbank"),h=require("../../common/constants/config"),u=require("./constants/pg-bank-search");let $=class extends o.BaseBankService{constructor(t,i){super(t,i),this.wsService=t,this.BANK_CODE="PGBANK",this.BUNDLE_ID="pgbankApp.pgbank.com.vn"}async inputPasswordFromConfig(t,i=3){const e=await this.deviceService.getDeviceConfig(t);if(!e||!e.password)throw Error("Password not configured for device "+t);for(let a=1;i>=a;a++)try{return await this.clickWithTransition(t,c.PG_UI_COORDINATES.PASSWORD_FIELD.x,c.PG_UI_COORDINATES.PASSWORD_FIELD.y,1500),await(0,s.sleep)(500),await this.wsService.inputText(t,e.password),a>1&&this.logger.log(`Successfully input password on device ${t} after ${a} attempt(s)`),void 0}catch(e){if(!(e instanceof Error&&e.message.includes("timeout")))throw this.logger.error(`Error inputting password from config for device ${t} (attempt ${a}/${i}): ${e.message}`),e;if(a>=i)throw this.logger.error(`Error inputting password from config for device ${t} (attempt ${a}/${i}): ${e.message}`),e;{const e=1e3*Math.pow(2,a-1);this.logger.warn(`WebSocket timeout when inputting password on device ${t} (attempt ${a}/${i}). Retrying in ${e}ms...`),await(0,s.sleep)(e)}}}async inputSmartOTPFromConfig(t,i=3){const e=await this.deviceService.getDeviceConfig(t);if(!e||!e.smartOTP)throw Error("SmartOTP not configured for device "+t);for(let a=1;i>=a;a++)try{return await(0,s.sleep)(500),await this.wsService.inputNumpadNumber(t,e.smartOTP),a>1&&this.logger.log(`Successfully input SmartOTP on device ${t} after ${a} attempt(s)`),void 0}catch(e){if(!(e instanceof Error&&e.message.includes("timeout")))throw this.logger.error(`Error inputting SmartOTP from config for device ${t} (attempt ${a}/${i}): ${e.message}`),e;if(a>=i)throw this.logger.error(`Error inputting SmartOTP from config for device ${t} (attempt ${a}/${i}): ${e.message}`),e;{const e=1e3*Math.pow(2,a-1);this.logger.warn(`WebSocket timeout when inputting SmartOTP on device ${t} (attempt ${a}/${i}). Retrying in ${e}ms...`),await(0,s.sleep)(e)}}}async login(t){try{await this.killApp(t),await this.launchApp(t),await(0,s.sleep)(1e3),await this.inputPasswordFromConfig(t),await this.wsService.pressReturnKey(t);const{x:i,y:e}=c.PG_UI_COORDINATES.LOGIN_BTN;await this.clickWithTransition(t,i,e,1e4,`Clicking login button after input password on device ${t} at coordinates (${i}, ${e})`),this.logger.log("PG login completed successfully on device "+t)}catch(i){throw this.logger.error(`Error logging in to PGBank on device ${t}: ${i.message}`),i}}executeTransfer(t,i){return"PGBANK"===t.bankCode?this.executeInternalTransfer(t,i):this.executeExternalTransfer(t,i)}async executeInternalTransfer(t,i){try{this.logger.log(`Executing PG transfer for withdrawal ${t.withdrawalId} on device ${i}`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.TRANSFER_BTN.x,c.PG_UI_COORDINATES.TRANSFER_BTN.y,5e3,`Clicking transfer button on device ${i} at coordinates (${c.PG_UI_COORDINATES.TRANSFER_BTN.x}, ${c.PG_UI_COORDINATES.TRANSFER_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.TRANSFER_INTERNAL_BTN.x,c.PG_UI_COORDINATES.TRANSFER_INTERNAL_BTN.y,3e3,`Clicking transfer internal button on device ${i} at coordinates (${c.PG_UI_COORDINATES.TRANSFER_INTERNAL_BTN.x}, ${c.PG_UI_COORDINATES.TRANSFER_INTERNAL_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.CLOSE_ALLOW_CONTACT_POPUP_BTN.x,c.PG_UI_COORDINATES.CLOSE_ALLOW_CONTACT_POPUP_BTN.y,3e3,`Clicking close allow contact popup button on device ${i} at coordinates (${c.PG_UI_COORDINATES.CLOSE_ALLOW_CONTACT_POPUP_BTN.x}, ${c.PG_UI_COORDINATES.CLOSE_ALLOW_CONTACT_POPUP_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.x,c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.y,3e3,`Clicking account number input field on device ${i} at coordinates (${c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.x}, ${c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.y})`),"HC"===h.config.boxType&&await this.wsService.switchKeyboardMode(i),await this.wsService.inputText(i,t.beneficiaryAccountNo),await this.wsService.pressReturnKey(i),await(0,s.sleep)(1e4),await this.clickWithTransition(i,c.PG_UI_COORDINATES.INTERNAL_AMOUNT_INPUT.x,c.PG_UI_COORDINATES.INTERNAL_AMOUNT_INPUT.y,1e3,`Clicking amount input field on device ${i} at coordinates (${c.PG_UI_COORDINATES.INTERNAL_AMOUNT_INPUT.x}, ${c.PG_UI_COORDINATES.INTERNAL_AMOUNT_INPUT.y})`),await this.wsService.inputText(i,t.amount.toString()),await this.clickWithTransition(i,c.PG_UI_COORDINATES.HIDE_NUMPAD_BTN.x,c.PG_UI_COORDINATES.HIDE_NUMPAD_BTN.y,500),await(0,s.sleep)(1e3),await this.clickWithTransition(i,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y,1e4,`Clicking continue transfer button on device ${i} at coordinates (${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x}, ${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y,15e3,`Clicking continue transfer button on device ${i} at coordinates (${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x}, ${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y})`),await this.inputSmartOTPFromConfig(i),await(0,s.sleep)(1e4),await this.captureScreen(i,{quality:.5,folderPath:t.withdrawalCode}),await this.clickWithTransition(i,c.PG_UI_COORDINATES.BACK_TO_HOME.x,c.PG_UI_COORDINATES.BACK_TO_HOME.y,1e4,`Clicking back to home button on device ${i} at coordinates (${c.PG_UI_COORDINATES.BACK_TO_HOME.x}, ${c.PG_UI_COORDINATES.BACK_TO_HOME.y})`)}catch(i){throw this.logger.error(`Error executing PG transfer for withdrawal ${t.withdrawalId}: ${i.message}`),i}}async executeExternalTransfer(t,i){try{this.logger.log(`Executing PG transfer for withdrawal ${t.withdrawalId} on device ${i}`);const e=u.PG_BANK_SEARCH_UI_COORDINATES[t.bankCode];if(!e)throw Error(`Bank ${t.bankCode} not found!`);await this.clickWithTransition(i,c.PG_UI_COORDINATES.TRANSFER_BTN.x,c.PG_UI_COORDINATES.TRANSFER_BTN.y,5e3,`Clicking transfer button on device ${i} at coordinates (${c.PG_UI_COORDINATES.TRANSFER_BTN.x}, ${c.PG_UI_COORDINATES.TRANSFER_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.TRANSFER_EXTERNAL_BTN.x,c.PG_UI_COORDINATES.TRANSFER_EXTERNAL_BTN.y,3e3,`Clicking transfer external button on device ${i} at coordinates (${c.PG_UI_COORDINATES.TRANSFER_EXTERNAL_BTN.x}, ${c.PG_UI_COORDINATES.TRANSFER_EXTERNAL_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.x,c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.y,2e3,`Clicking account number input field on device ${i} at coordinates (${c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.x}, ${c.PG_UI_COORDINATES.ACCOUNT_NUMBER_INPUT.y})`),"HC"===h.config.boxType&&await this.wsService.switchKeyboardMode(i),await this.wsService.inputText(i,t.beneficiaryAccountNo),await this.wsService.pressReturnKey(i),await this.clickWithTransition(i,c.PG_UI_COORDINATES.BANK_SEARCH_BTN.x,c.PG_UI_COORDINATES.BANK_SEARCH_BTN.y,1e3,`Clicking account number input field on device ${i} at coordinates (${c.PG_UI_COORDINATES.BANK_SEARCH_BTN.x}, ${c.PG_UI_COORDINATES.BANK_SEARCH_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.BANK_SEARCH_INPUT.x,c.PG_UI_COORDINATES.BANK_SEARCH_INPUT.y,2e3,`Clicking account number input field on device ${i} at coordinates (${c.PG_UI_COORDINATES.BANK_SEARCH_INPUT.x}, ${c.PG_UI_COORDINATES.BANK_SEARCH_INPUT.y})`),await this.wsService.inputText(i,e.searchValue),await(0,s.sleep)(1e3),await this.wsService.pressReturnKey(i),await this.clickWithTransition(i,e.coordinates.x,e.coordinates.y,1e4,`Clicking bank on device ${i} at coordinates (${e.coordinates.x}, ${e.coordinates.y})`),await this.wsService.swipe(i,{type:"6"}),await(0,s.sleep)(3e3),await this.clickWithTransition(i,c.PG_UI_COORDINATES.EXTERNAL_AMOUNT_INPUT.x,c.PG_UI_COORDINATES.EXTERNAL_AMOUNT_INPUT.y,2e3,`Clicking amount input field on device ${i} at coordinates (${c.PG_UI_COORDINATES.EXTERNAL_AMOUNT_INPUT.x}, ${c.PG_UI_COORDINATES.EXTERNAL_AMOUNT_INPUT.y})`),await this.wsService.inputText(i,t.amount.toString()),await this.clickWithTransition(i,c.PG_UI_COORDINATES.HIDE_NUMPAD_BTN.x,c.PG_UI_COORDINATES.HIDE_NUMPAD_BTN.y,500),await this.clickWithTransition(i,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y,1e4,`Clicking continue transfer button on device ${i} at coordinates (${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x}, ${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y})`),await this.clickWithTransition(i,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x,c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y,15e3,`Clicking continue transfer button on device ${i} at coordinates (${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.x}, ${c.PG_UI_COORDINATES.CONTINUE_TRANSFER_BTN.y})`),await this.inputSmartOTPFromConfig(i),await(0,s.sleep)(1e4),await this.captureScreen(i,{quality:.5,folderPath:t.withdrawalCode}),await this.clickWithTransition(i,c.PG_UI_COORDINATES.BACK_TO_HOME.x,c.PG_UI_COORDINATES.BACK_TO_HOME.y,1e4,`Clicking back to home button on device ${i} at coordinates (${c.PG_UI_COORDINATES.BACK_TO_HOME.x}, ${c.PG_UI_COORDINATES.BACK_TO_HOME.y})`)}catch(i){throw this.logger.error(`Error executing PG transfer for withdrawal ${t.withdrawalId}: ${i.message}`),i}}async onModuleInit(){}onModuleDestroy(){}};exports.PgService=$,exports.PgService=$=t([(0,a.Injectable)(),e(0,(0,a.Inject)(r.WEBSOCKET_SERVICE)),i("design:paramtypes",[Object,n.DeviceService])],$);