"use strict";var e,s=this&&this.t||function(e,s,t,i){var n,o=arguments.length,r=3>o?s:null===i?i=Object.getOwnPropertyDescriptor(s,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,s,t,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(r=(3>o?n(r):o>3?n(s,t,r):n(s,t))||r);return o>3&&r&&Object.defineProperty(s,t,r),r},t=this&&this.i||function(e,s){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,s)};Object.defineProperty(exports,"o",{value:!0}),exports.SessionManagementService=void 0;const i=require("@nestjs/common"),n=require("../../common/services/redis.service");let o=e=class{constructor(s){this.redisService=s,this.logger=new i.Logger(e.name),this.REDIS_SESSION_PREFIX="bank:session:",this.BANK_SESSION_CONFIGS=new Map([["ACB",{bankCode:"ACB",sessionTimeoutMs:9e5,refreshBeforeMs:6e4}],["PGBANK",{bankCode:"PGBANK",sessionTimeoutMs:3e5,refreshBeforeMs:3e4}]])}getSessionTimeout(e){const s=this.BANK_SESSION_CONFIGS.get(e.toUpperCase());return s?.sessionTimeoutMs||3e5}getRefreshBeforeTime(e){const s=this.BANK_SESSION_CONFIGS.get(e.toUpperCase());return s?.refreshBeforeMs||3e4}async recordLogin(e,s){const t=this.getSessionTimeout(s),i=Date.now()+t,n={deviceId:e,bankCode:s.toUpperCase(),loginTime:Date.now(),expiresAt:i,status:"logged_in"},o=`${this.REDIS_SESSION_PREFIX}${e}:${s.toUpperCase()}`;await this.redisService.set(o,JSON.stringify(n),t),this.logger.log(`Recorded login session for device ${e}, bank ${s}, expires at ${new Date(i).toISOString()}`)}async markLoggingIn(e,s){const t=`${this.REDIS_SESSION_PREFIX}${e}:${s.toUpperCase()}`,i=await this.getSession(e,s),n={deviceId:e,bankCode:s.toUpperCase(),loginTime:i?.loginTime||Date.now(),expiresAt:i?.expiresAt||Date.now()+this.getSessionTimeout(s),status:"logging_in"};await this.redisService.set(t,JSON.stringify(n),3e5),this.logger.log(`Marked device ${e}, bank ${s} as logging in`)}async getSession(e,s){try{const t=`${this.REDIS_SESSION_PREFIX}${e}:${s.toUpperCase()}`,i=await this.redisService.get(t);return i?JSON.parse(i):null}catch(t){return this.logger.error(`Error getting session for device ${e}, bank ${s}: ${t.message}`),null}}async isSessionValid(e,s){const t=await this.getSession(e,s);return!!t&&t.expiresAt>=Date.now()&&"logging_in"!==t.status&&"logged_in"===t.status}async needsRefresh(e,s){const t=await this.getSession(e,s);return!(!t||"logged_in"!==t.status||this.getRefreshBeforeTime(s)<t.expiresAt-Date.now())}async clearSession(e,s){const t=`${this.REDIS_SESSION_PREFIX}${e}:${s.toUpperCase()}`;await this.redisService.del(t),this.logger.log(`Cleared session for device ${e}, bank ${s}`)}};exports.SessionManagementService=o,exports.SessionManagementService=o=e=s([(0,i.Injectable)(),t("design:paramtypes",[n.RedisService])],o);