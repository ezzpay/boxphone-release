"use strict";var t,i=this&&this.t||function(t,i,e,s){var a,r=arguments.length,o=3>r?i:null===s?s=Object.getOwnPropertyDescriptor(i,e):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,i,e,s);else for(var c=t.length-1;c>=0;c--)(a=t[c])&&(o=(3>r?a(o):r>3?a(i,e,o):a(i,e))||o);return r>3&&o&&Object.defineProperty(i,e,o),o},e=this&&this.i||function(t,i){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,i)},s=this&&this.o||function(t,i){return function(e,s){i(e,s,t)}};Object.defineProperty(exports,"h",{value:!0}),exports.WithdrawalService=void 0;const a=require("@nestjs/common"),r=require("../../common/services/ezpay-be-client.service"),o=require("../bank/bank.service"),c=require("../device/device.service"),n=require("../device/device-lock.service"),h=require("../../common/services/redis.service"),w=require("../../common/modules/websocket/constants/websocket"),d=require("./withdrawal-errors");let l=t=class{constructor(i,e,s,r,o,c){this.ezpayBeClient=i,this.wsService=e,this.bankService=s,this.deviceService=r,this.deviceLock=o,this.redisService=c,this.logger=new a.Logger(t.name),this.REDIS_PROCESSED_PREFIX="withdrawal:processed:",this.PROCESSING_TTL=36e5,this.COMPLETED_TTL=864e5}async checkIfProcessed(t){try{const i=`${this.REDIS_PROCESSED_PREFIX}${t}`,e=await this.redisService.get(i);return"completed"===e?(this.logger.warn(`Withdrawal ${t} already completed`),!0):"processing"===e&&(this.logger.warn(`Withdrawal ${t} is being processed by another instance`),!0)}catch(i){return this.logger.error(`Error checking processed status for ${t}: ${i.message}`),!1}}async markAsProcessing(t){try{const i=`${this.REDIS_PROCESSED_PREFIX}${t}`;return"OK"===await this.redisService.setnx(i,"processing",this.PROCESSING_TTL)?(this.logger.debug(`Marked withdrawal ${t} as processing`),!0):(this.logger.warn(`Withdrawal ${t} is already being processed by another instance`),!1)}catch(i){return this.logger.error(`Error marking withdrawal ${t} as processing: ${i.message}`),!0}}async markAsCompleted(t){try{const i=`${this.REDIS_PROCESSED_PREFIX}${t}`;await this.redisService.set(i,"completed",this.COMPLETED_TTL),this.logger.log(`Marked withdrawal ${t} as completed`)}catch(i){this.logger.error(`Error marking withdrawal ${t} as completed: ${i.message}`)}}async markAsFailed(t){try{const i=`${this.REDIS_PROCESSED_PREFIX}${t}`;await this.redisService.del(i),this.logger.log(`Marked withdrawal ${t} as failed (removed from processed list)`)}catch(i){this.logger.error(`Error marking withdrawal ${t} as failed: ${i.message}`)}}async processWithdrawal(t,i){this.logger.debug("ðŸš€ ~ WithdrawalService ~ processWithdrawal ~ withdrawal:",t);const{withdrawalId:e,bankCode:s,amount:a,l:r}=t;if(!e){const t="Withdrawal ID is required";throw this.logger.error(t),new d.WithdrawalProcessingError(t,d.ErrorType.PERMANENT,e||"unknown")}if(!i){const t="No device assigned for withdrawal "+e;throw this.logger.error(t),new d.WithdrawalProcessingError(t,d.ErrorType.PERMANENT,e)}if(await this.checkIfProcessed(e))return this.logger.warn(`Withdrawal ${e} already processed or being processed, skipping`),!0;if(!await this.markAsProcessing(e)){const t=`Withdrawal ${e} is being processed by another instance`;throw this.logger.warn(t),new d.WithdrawalProcessingError(t,d.ErrorType.TEMPORARY,e)}let o=!0,c=!1;try{this.logger.log(`Processing withdrawal: ${e} for bank: ${s}, amount: ${a} on assigned device: ${i}`);const r=await this.deviceService.getDeviceConfig(i);if(!r||"active"!==r.status){const t=`Assigned device ${i} is not active or not found`;throw this.logger.error(t),await this.markAsFailed(e),o=!1,new d.WithdrawalProcessingError(t,d.ErrorType.TEMPORARY,e)}if(r.availableAmount<a){const t=`Assigned device ${i} has insufficient amount. Available: ${r.availableAmount}, Required: ${a}`;throw this.logger.error(t),await this.markAsFailed(e),o=!1,new d.WithdrawalProcessingError(t,d.ErrorType.PERMANENT,e)}if(!await this.bankService.isSessionValid(i,r.bankCode)){const t=`Assigned device ${i} does not have valid session for bank ${r.bankCode}`;throw this.logger.error(t),await this.markAsFailed(e),o=!1,new d.WithdrawalProcessingError(t,d.ErrorType.TEMPORARY,e)}const n=i,h=`withdraw:${e}:${n}`;if(!await this.deviceLock.acquireLock(n,"transfer",h,6e5)){const t="Failed to acquire lock for device "+n;throw this.logger.warn(t),await this.markAsFailed(e),o=!1,new d.WithdrawalProcessingError(t,d.ErrorType.TEMPORARY,e)}try{if(await this.bankService.executeTransfer(t,n,r.bankCode,!0)){await this.deviceService.deductDeviceAmount(n,a)||this.logger.error("Failed to deduct amount from device "+n),await this.markAsCompleted(e),c=!0,o=!1;let i=null,s="unknown";try{const a=await this.bankService.analyzeTransferBill(r.bankCode,t);a?(i=a.raw,s=a.analyzedStatus,this.logger.log(`Successfully analyzed receipt for withdrawal ${e}, OCR analyzedStatus: ${a.analyzedStatus}, success: ${a.success}`)):this.logger.warn("No analysis result found for withdrawal "+e)}catch(t){this.logger.error(`Error analyzing receipt for withdrawal ${e}: ${t.message}`)}return await this.notifyEzpayBe(t,"success",i||""),"success"!==s&&this.bankService.login(r.bankCode,n,!0),this.logger.log("Successfully processed withdrawal: "+e),!0}{const t="Transfer failed for withdrawal "+e;throw this.logger.error(t),await this.markAsFailed(e),o=!1,new d.WithdrawalProcessingError(t,d.ErrorType.UNKNOWN,e)}}finally{try{await this.deviceLock.releaseLock(n),this.logger.debug(`Released lock for device ${n} after processing withdrawal ${e}`)}catch(t){this.logger.error(`Error releasing lock for device ${n} after processing withdrawal ${e}: ${t.message}`,t.stack)}}}catch(t){if(t instanceof d.WithdrawalProcessingError)throw t;throw this.logger.error(`Error processing withdrawal ${e}: ${t.message}`,t.stack),await this.markAsFailed(e),o=!1,new d.WithdrawalProcessingError(t.message||"Unknown error",d.ErrorType.UNKNOWN,e)}finally{if(o&&!c)try{await this.markAsFailed(e),this.logger.debug(`Cleaned up Redis for withdrawal ${e} in finally block`)}catch(t){this.logger.error(`Error cleaning up Redis for withdrawal ${e} in finally: ${t.message}`)}}}async notifyEzpayBe(t,i,e){this.logger.debug("ðŸš€ ~ WithdrawalService ~ notifyEzpayBe ~ withdrawal:",t);try{await this.ezpayBeClient.updateWithdrawalStatus(t.l,{analyzedStatus:i,sourceAccountNo:t.beneficiaryAccountNo,sourceBankCode:t.bankCode,receipt:e})||this.logger.error(`Failed to notify ezpay-be about withdrawal ${t.l} status ${i}`)}catch(i){throw this.logger.error(`Error notifying ezpay-be about withdrawal ${t.l}: ${i.message}`),i}}};exports.WithdrawalService=l,exports.WithdrawalService=l=t=i([(0,a.Injectable)(),s(1,(0,a.Inject)(w.WEBSOCKET_SERVICE)),s(3,(0,a.Inject)((0,a.forwardRef)(()=>c.DeviceService))),e("design:paramtypes",[r.EzpayBeClientService,Object,o.BankService,c.DeviceService,n.DeviceLockService,h.RedisService])],l);