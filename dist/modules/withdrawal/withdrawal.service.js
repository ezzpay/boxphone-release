"use strict";var t,e=this&&this.t||function(t,e,i,s){var a,r=arguments.length,o=3>r?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(a=t[n])&&(o=(3>r?a(o):r>3?a(e,i,o):a(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o},i=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},s=this&&this.o||function(t,e){return function(i,s){e(i,s,t)}};Object.defineProperty(exports,"h",{value:!0}),exports.WithdrawalService=void 0;const a=require("@nestjs/common"),r=require("../../common/services/ezpay-be-client.service"),o=require("../bank/bank.service"),n=require("../device/device.service"),c=require("../device/device-lock.service"),h=require("../../common/services/redis.service"),d=require("../../common/modules/websocket/constants/websocket"),w=require("./withdrawal-errors"),l=require("lodash");let u=t=class{constructor(e,i,s,r,o,n){this.ezpayBeClient=e,this.wsService=i,this.bankService=s,this.deviceService=r,this.deviceLock=o,this.redisService=n,this.logger=new a.Logger(t.name),this.REDIS_PROCESSED_PREFIX="withdrawal:processed:",this.PROCESSING_TTL=36e5,this.COMPLETED_TTL=864e5}async checkIfProcessed(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`,i=await this.redisService.get(e);return"completed"===i?(this.logger.warn(`Withdrawal ${t} already completed`),!0):"processing"===i&&(this.logger.warn(`Withdrawal ${t} is being processed by another instance`),!0)}async markAsProcessing(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`;return"OK"===await this.redisService.setnx(e,"processing",this.PROCESSING_TTL)?(this.logger.debug(`Marked withdrawal ${t} as processing`),!0):(this.logger.warn(`Withdrawal ${t} is already being processed by another instance`),!1)}async markAsCompleted(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`;await this.redisService.set(e,"completed",this.COMPLETED_TTL),this.logger.log(`Marked withdrawal ${t} as completed`)}async markAsFailed(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`;await this.redisService.del(e),this.logger.log(`Marked withdrawal ${t} as failed (removed from processed list)`)}async processWithdrawal(t,e){const i=(0,l.cloneDeep)(t);this.logger.debug("ðŸš€ ~ WithdrawalService ~ processWithdrawal ~ withdrawal:",i);const{withdrawalId:s,bankCode:a,amount:r,l:o}=i;if(!s){const t="Withdrawal ID is required";throw this.logger.error(t),new w.WithdrawalProcessingError(t,w.ErrorType.PERMANENT,s||"unknown")}if(!e){const t="No device assigned for withdrawal "+s;throw this.logger.error(t),new w.WithdrawalProcessingError(t,w.ErrorType.PERMANENT,s)}if(await this.checkIfProcessed(s))return this.logger.warn(`Withdrawal ${s} already processed or being processed, skipping`),!0;if(!await this.markAsProcessing(s)){const t=`Withdrawal ${s} is being processed by another instance`;throw this.logger.warn(t),new w.WithdrawalProcessingError(t,w.ErrorType.TEMPORARY,s)}this.logger.log(`Processing withdrawal: ${s} for bank: ${a}, amount: ${r} on assigned device: ${e}`);const n=await this.deviceService.getDeviceConfig(e);if(!n||"active"!==n.status){const t=`Assigned device ${e} is not active or not found`;throw this.logger.error(t),await this.markAsFailed(s),new w.WithdrawalProcessingError(t,w.ErrorType.TEMPORARY,s)}if(n.availableAmount<r){const t=`Assigned device ${e} has insufficient amount. Available: ${n.availableAmount}, Required: ${r}`;throw this.logger.error(t),await this.markAsFailed(s),new w.WithdrawalProcessingError(t,w.ErrorType.PERMANENT,s)}if(!await this.bankService.isSessionValid(e,n.bankCode)){const t=`Assigned device ${e} does not have valid session for bank ${n.bankCode}`;throw this.logger.error(t),await this.markAsFailed(s),new w.WithdrawalProcessingError(t,w.ErrorType.TEMPORARY,s)}const c=e;if(await this.bankService.executeTransfer(i,c,n.bankCode,!0)){await this.deviceService.deductDeviceAmount(c,r)||this.logger.error("Failed to deduct amount from device "+c),await this.markAsCompleted(s);let t=null,e="unknown";const a=await this.bankService.analyzeTransferBill(n.bankCode,i);return a?(t=a.raw,e=a.analyzedStatus,this.logger.log(`Successfully analyzed receipt for withdrawal ${s}, OCR analyzedStatus: ${a.analyzedStatus}, success: ${a.success}`)):this.logger.warn("No analysis result found for withdrawal "+s),await this.notifyEzpayBe(i,"success",t||""),"success"!==e&&this.bankService.login(n.bankCode,c,!0),this.logger.log("Successfully processed withdrawal: "+s),!0}{const t="Transfer failed for withdrawal "+s;throw this.logger.error(t),await this.markAsFailed(s),new w.WithdrawalProcessingError(t,w.ErrorType.UNKNOWN,s)}}async notifyEzpayBe(t,e,i){if(this.logger.debug("ðŸš€ ~ WithdrawalService ~ notifyEzpayBe ~ withdrawal:",t),this.logger.debug("ðŸš€ ~ WithdrawalService ~ notifyEzpayBe ~ withdrawalId:",t.withdrawalId),!t.l)throw this.logger.error(`Withdrawal _id is missing for withdrawal ${t.withdrawalId}. Cannot notify backend.`),Error("Withdrawal _id is missing for "+t.withdrawalId);await this.ezpayBeClient.updateWithdrawalStatus(t.l,{analyzedStatus:e,sourceAccountNo:t.beneficiaryAccountNo,sourceBankCode:t.bankCode,receipt:i})||this.logger.error(`Failed to notify ezpay-be about withdrawal ${t.l} status ${e}`)}};exports.WithdrawalService=u,exports.WithdrawalService=u=t=e([(0,a.Injectable)(),s(1,(0,a.Inject)(d.WEBSOCKET_SERVICE)),s(3,(0,a.Inject)((0,a.forwardRef)(()=>n.DeviceService))),i("design:paramtypes",[r.EzpayBeClientService,Object,o.BankService,n.DeviceService,c.DeviceLockService,h.RedisService])],u);