"use strict";var t,e=this&&this.t||function(t,e,i,s){var a,r=arguments.length,o=3>r?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(a=t[n])&&(o=(3>r?a(o):r>3?a(e,i,o):a(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o},i=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},s=this&&this.o||function(t,e){return function(i,s){e(i,s,t)}};Object.defineProperty(exports,"h",{value:!0}),exports.WithdrawalService=void 0;const a=require("@nestjs/common"),r=require("../../common/services/ezpay-be-client.service"),o=require("../bank/bank.service"),n=require("../device/device.service"),c=require("../device/device-lock.service"),h=require("../../common/services/redis.service"),d=require("../../common/modules/websocket/constants/websocket"),w=require("./withdrawal-errors");let l=t=class{constructor(e,i,s,r,o,n){this.ezpayBeClient=e,this.wsService=i,this.bankService=s,this.deviceService=r,this.deviceLock=o,this.redisService=n,this.logger=new a.Logger(t.name),this.REDIS_PROCESSED_PREFIX="withdrawal:processed:",this.PROCESSING_TTL=36e5,this.COMPLETED_TTL=864e5}async checkIfProcessed(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`,i=await this.redisService.get(e);return"completed"===i?(this.logger.warn(`Withdrawal ${t} already completed`),!0):"processing"===i&&(this.logger.warn(`Withdrawal ${t} is being processed by another instance`),!0)}async markAsProcessing(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`;return"OK"===await this.redisService.setnx(e,"processing",this.PROCESSING_TTL)?(this.logger.debug(`Marked withdrawal ${t} as processing`),!0):(this.logger.warn(`Withdrawal ${t} is already being processed by another instance`),!1)}async markAsCompleted(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`;await this.redisService.set(e,"completed",this.COMPLETED_TTL),this.logger.log(`Marked withdrawal ${t} as completed`)}async markAsFailed(t){const e=`${this.REDIS_PROCESSED_PREFIX}${t}`;await this.redisService.del(e),this.logger.log(`Marked withdrawal ${t} as failed (removed from processed list)`)}async processWithdrawal(t,e){this.logger.debug("ðŸš€ ~ WithdrawalService ~ processWithdrawal ~ withdrawal:",t);const{withdrawalId:i,bankCode:s,amount:a,l:r}=t;if(!i){const t="Withdrawal ID is required";throw this.logger.error(t),new w.WithdrawalProcessingError(t,w.ErrorType.PERMANENT,i||"unknown")}if(!e){const t="No device assigned for withdrawal "+i;throw this.logger.error(t),new w.WithdrawalProcessingError(t,w.ErrorType.PERMANENT,i)}if(await this.checkIfProcessed(i))return this.logger.warn(`Withdrawal ${i} already processed or being processed, skipping`),!0;if(!await this.markAsProcessing(i)){const t=`Withdrawal ${i} is being processed by another instance`;throw this.logger.warn(t),new w.WithdrawalProcessingError(t,w.ErrorType.TEMPORARY,i)}this.logger.log(`Processing withdrawal: ${i} for bank: ${s}, amount: ${a} on assigned device: ${e}`);const o=await this.deviceService.getDeviceConfig(e);if(!o||"active"!==o.status){const t=`Assigned device ${e} is not active or not found`;throw this.logger.error(t),await this.markAsFailed(i),new w.WithdrawalProcessingError(t,w.ErrorType.TEMPORARY,i)}if(o.availableAmount<a){const t=`Assigned device ${e} has insufficient amount. Available: ${o.availableAmount}, Required: ${a}`;throw this.logger.error(t),await this.markAsFailed(i),new w.WithdrawalProcessingError(t,w.ErrorType.PERMANENT,i)}if(!await this.bankService.isSessionValid(e,o.bankCode)){const t=`Assigned device ${e} does not have valid session for bank ${o.bankCode}`;throw this.logger.error(t),await this.markAsFailed(i),new w.WithdrawalProcessingError(t,w.ErrorType.TEMPORARY,i)}const n=e;if(await this.bankService.executeTransfer(t,n,o.bankCode,!0)){await this.deviceService.deductDeviceAmount(n,a)||this.logger.error("Failed to deduct amount from device "+n),await this.markAsCompleted(i);let e=null,s="unknown";const r=await this.bankService.analyzeTransferBill(o.bankCode,t);return r?(e=r.raw,s=r.analyzedStatus,this.logger.log(`Successfully analyzed receipt for withdrawal ${i}, OCR analyzedStatus: ${r.analyzedStatus}, success: ${r.success}`)):this.logger.warn("No analysis result found for withdrawal "+i),await this.notifyEzpayBe(t,"success",e||""),"success"!==s&&this.bankService.login(o.bankCode,n,!0),this.logger.log("Successfully processed withdrawal: "+i),!0}{const t="Transfer failed for withdrawal "+i;throw this.logger.error(t),await this.markAsFailed(i),new w.WithdrawalProcessingError(t,w.ErrorType.UNKNOWN,i)}}async notifyEzpayBe(t,e,i){if(this.logger.debug("ðŸš€ ~ WithdrawalService ~ notifyEzpayBe ~ withdrawal:",t),this.logger.debug("ðŸš€ ~ WithdrawalService ~ notifyEzpayBe ~ withdrawalId:",t.withdrawalId),!t.l)throw this.logger.error(`Withdrawal _id is missing for withdrawal ${t.withdrawalId}. Cannot notify backend.`),Error("Withdrawal _id is missing for "+t.withdrawalId);await this.ezpayBeClient.updateWithdrawalStatus(t.l,{analyzedStatus:e,sourceAccountNo:t.beneficiaryAccountNo,sourceBankCode:t.bankCode,receipt:i})||this.logger.error(`Failed to notify ezpay-be about withdrawal ${t.l} status ${e}`)}};exports.WithdrawalService=l,exports.WithdrawalService=l=t=e([(0,a.Injectable)(),s(1,(0,a.Inject)(d.WEBSOCKET_SERVICE)),s(3,(0,a.Inject)((0,a.forwardRef)(()=>n.DeviceService))),i("design:paramtypes",[r.EzpayBeClientService,Object,o.BankService,n.DeviceService,c.DeviceLockService,h.RedisService])],l);