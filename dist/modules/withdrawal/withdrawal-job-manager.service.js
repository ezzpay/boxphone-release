"use strict";var t,e=this&&this.t||function(t,e,i,s){var r,a=arguments.length,o=3>a?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(r=t[n])&&(o=(3>a?r(o):a>3?r(e,i,o):r(e,i))||o);return a>3&&o&&Object.defineProperty(e,i,o),o},i=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},s=this&&this.o||function(t,e){return function(i,s){e(i,s,t)}};Object.defineProperty(exports,"h",{value:!0}),exports.WithdrawalJobManagerService=void 0;const r=require("@nestjs/common"),a=require("@nestjs/schedule"),o=require("@nestjs/bull"),n=require("./withdrawal.service"),c=require("../device/device.service"),h=require("../device/device-lock.service"),l=require("../../common/modules/websocket/constants/websocket"),d=require("./withdrawal-errors"),u=require("lodash"),w=require("../../common/redis/cron-lock");let p=t=class{constructor(e,i,s,a,o){this.withdrawalQueue=e,this.withdrawalService=i,this.deviceService=s,this.deviceLock=a,this.wsService=o,this.logger=new r.Logger(t.name),this.processingJobs=new Set,this.isInitialized=!1}async onModuleInit(){this.logger.log("WithdrawalJobManagerService initialized, waiting 5 seconds before starting..."),setTimeout(()=>{this.initializeJobProcessing()},5e3)}async initializeJobProcessing(){this.isInitialized||await this.startProcessing()}async startProcessing(){try{this.logger.log("Starting withdrawal job processing..."),await this.pickAndProcessJobs(),this.isInitialized=!0}catch(t){this.logger.error("Error starting job processing: "+t.message,t.stack)}}async getAvailableDevices(){try{const t=await this.wsService.listDevices(),e=[];for(const i of t){const t=await this.deviceService.getDeviceConfig(i.udid);"active"===t?.status&&(await this.deviceLock.isLocked(i.udid)||e.push({udid:i.udid,config:t}))}return e}catch(t){return this.logger.error("Error getting available devices: "+t.message),[]}}async pickAndProcessJobs(t){try{const e=await this.deviceService.getServiceStatus();if("active"!==e)return this.logger.debug(`Service is ${e}, cannot pick jobs`),void 0;const i=await this.getAvailableDevices(),s=i.length;if(0>=s)return;const r=t?Math.min(t,s):s,a=await this.withdrawalQueue.getJobs(["waiting"],0,r-1);if(0===a.length)return;this.logger.log(`Found ${i.length} available devices. Picking ${a.length} jobs (${(a||[]).length} waiting.`);for(let t=0;t<a.length;t++){const e=a[t],s=i[t];if(this.logger.debug("Processing jobs: "+JSON.stringify(this.processingJobs)),this.processingJobs.has(e.id))continue;const r=`withdraw:${e.data.withdrawalId}:${s.udid}`;await this.deviceLock.acquireLock(s.udid,"transfer",r,220800)?this.processJob(e,s.udid).catch(t=>{this.deviceLock.releaseLock(s.udid).catch(()=>{}),this.logger.error(`Error processing job ${e.id}: ${t.message}`,t.stack)}):this.logger.warn(`Device ${s.udid} was locked after assignment, skipping job ${e.id}`)}}catch(t){this.logger.error("Error picking jobs: "+t.message,t.stack)}}async processJob(t,e){const i=(0,u.cloneDeep)(t.data),{withdrawalId:s}=i;try{this.logger.log(`Successfully processed and removed withdrawal ${s} from queue`),await t.remove()}catch(e){this.logger.warn(`Could not remove completed job ${t.id}: ${e.message}`)}i&&i.withdrawalId||this.logger.error("Invalid withdrawal data in job "+t.id),this.processingJobs.add(t.id);try{await this.withdrawalService.processWithdrawal(i,e)}catch(t){let e;this.logger.error(`Error processing withdrawal ${s}: ${t.message}`,t.stack),e=t instanceof d.WithdrawalProcessingError?t.errorType:(0,d.classifyError)(t.message,t),await this.handleJobFailure(i,t.message,e)}finally{this.processingJobs.delete(t.id)}}async handleJobFailure(t,e,i=d.ErrorType.UNKNOWN){const s=t.manualRetryCount??0;if(this.logger.warn(`Withdrawal ${t.withdrawalId} failed. Reason: ${e}. Error Type: ${i}. Retry attempt: ${s}/3`),3>s){if(i===d.ErrorType.UNKNOWN)return;await this.withdrawalQueue.add("process-withdrawal-request",{...t,manualRetryCount:s+1,lastErrorType:i,lastErrorReason:e},{attempts:0,removeOnComplete:!1,removeOnFail:!1,jobId:"withdrawal-request-"+t.withdrawalId,priority:0,delay:3e4})}else this.logger.warn(`Max retries (3) exceeded for withdrawal ${t.withdrawalId}: ${i} error: ${e}`)}async triggerPickJobs(t=1){await this.pickAndProcessJobs(t)}async getQueueStats(){const[t,e,i,s,r,a,o]=await Promise.all([this.withdrawalQueue.getWaitingCount(),this.withdrawalQueue.getDelayedCount(),this.withdrawalQueue.getActiveCount(),this.withdrawalQueue.getCompletedCount(),this.withdrawalQueue.getFailedCount(),this.getAvailableDevices(),this.deviceService.getServiceStatus()]);return{serviceStatus:o,activeDevices:a.length,processingJobs:this.processingJobs.size,isInitialized:this.isInitialized,queue:{waiting:t,delayed:e,active:i,completed:s,failed:r,total:t+e+i}}}async debugQueue(){const t=await this.getQueueStats(),[e,i]=await Promise.all([this.withdrawalQueue.getJobs(["waiting"],0,9),this.withdrawalQueue.getJobs(["delayed"],0,9)]);return{...t,sampleWaitingJobs:e.map(t=>({id:t.id,data:t.data,opts:t.opts,manualRetryCount:t.data.manualRetryCount})),sampleDelayedJobs:i.map(t=>({id:t.id,data:t.data,opts:t.opts,manualRetryCount:t.data.manualRetryCount}))}}async periodicJobPicking(){await this.pickAndProcessJobs()}async promoteDelayedJobs(){(0,w.withCronLock)("cron:promote_delayed:withdrawal",5e3,async()=>{const t=Date.now(),e=await this.withdrawalQueue.getJobs(["delayed"],0,99);if(!e.length)return;let i=0;for(const s of e){const e="number"==typeof s.opts?.delay?s.opts.delay:0;if(t>=("number"==typeof s.timestamp?s.timestamp:0)+e)try{await s.promote(),i++}catch(t){this.logger.debug(`Promote skipped for job ${s.id}: ${t+""}`)}}i>0&&this.logger.log(`Promoted ${i} delayed jobs to waiting`)})}};exports.WithdrawalJobManagerService=p,e([(0,a.Cron)("*/5 * * * * *"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],p.prototype,"periodicJobPicking",null),e([(0,a.Cron)("*/5 * * * * *"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],p.prototype,"promoteDelayedJobs",null),exports.WithdrawalJobManagerService=p=t=e([(0,r.Injectable)(),s(0,(0,o.InjectQueue)("wda-request")),s(4,(0,r.Inject)(l.WEBSOCKET_SERVICE)),i("design:paramtypes",[Object,n.WithdrawalService,c.DeviceService,h.DeviceLockService,Object])],p);