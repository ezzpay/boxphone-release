"use strict";var e,t=this&&this.t||function(e,t,i,s){var r,c=arguments.length,n=3>c?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(n=(3>c?r(n):c>3?r(t,i,n):r(t,i))||n);return c>3&&n&&Object.defineProperty(t,i,n),n},i=this&&this.i||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=this&&this.o||function(e,t){return function(i,s){t(i,s,e)}};Object.defineProperty(exports,"u",{value:!0}),exports.DeviceController=void 0;const r=require("@nestjs/common"),c=require("./device.service"),n=require("./dto/device-config.dto"),a=require("../bank/bank.service"),o=require("../../common/constants/config");let u=e=class{constructor(t,i){this.deviceService=t,this.bankService=i,this.logger=new r.Logger(e.name)}async getDevicesPage(){return{devices:await this.deviceService.listDevices(),serviceStatus:await this.deviceService.getServiceStatus(),banks:["VIETCOMBANK","TPBANK","TECHCOMBANK","ACB","PGBANK"],boxType:o.config.boxType}}async getDevices(){return{success:!0,data:await this.deviceService.listDevices()}}async getDeviceConfig(e){return{success:!0,data:await this.deviceService.getDeviceConfig(e)}}async retryLogin(e){try{this.logger.log("Retry login requested for device "+e);const t=await this.deviceService.getDeviceConfig(e);if(!t)throw new r.HttpException({success:!1,error:`Device ${e} not found or not configured`},r.HttpStatus.BAD_REQUEST);if(!t.bankCode||""===t.bankCode.trim())throw new r.HttpException({success:!1,error:`Device ${e} does not have bankCode configured. Please configure bankCode first.`},r.HttpStatus.BAD_REQUEST);if("active"!==t.status)throw new r.HttpException({success:!1,error:`Device ${e} is not active. Please activate the device first.`},r.HttpStatus.BAD_REQUEST);const i=t.bankCode.toUpperCase();return await this.bankService.login(i,e),{success:!0,message:`Successfully logged in to ${i} on device ${e}`}}catch(t){if(t instanceof r.HttpException)throw t;throw this.logger.error(`Error retrying login for device ${e}: ${t.message}`,t.stack),new r.HttpException({success:!1,error:t.message||"Failed to retry login"},r.HttpStatus.INTERNAL_SERVER_ERROR)}}async updateDeviceConfig(e,t){try{this.logger.log(`Updating device config for ${e}: ${JSON.stringify(t)}`);const i=await this.deviceService.getDeviceConfig(e);if("active"===(void 0!==t.status?t.status:i?.status||"deactive")){const e=[],s=void 0!==t.bankCode?t.bankCode:i?.bankCode;s&&""!==s.trim()||e.push("Bank Code là bắt buộc khi status là active");const c=void 0!==t.availableAmount?t.availableAmount:i?.availableAmount;(null==c||0>c)&&e.push("Available Amount là bắt buộc và phải >= 0 khi status là active");const n=void 0!==t.password?t.password:i?.password;n&&""!==n.trim()||e.push("Password là bắt buộc khi status là active");const a=void 0!==t.smartOTP?t.smartOTP:i?.smartOTP;if(a&&""!==a.trim()||e.push("Smart OTP là bắt buộc khi status là active"),e.length>0)throw new r.HttpException({success:!1,error:e.join(", ")},r.HttpStatus.BAD_REQUEST)}return{success:!0,data:await this.deviceService.updateDeviceConfig(e,t)}}catch(t){if(t instanceof r.HttpException)throw t;throw this.logger.error(`Error updating device config for ${e}: ${t.message}`,t.stack),new r.HttpException({success:!1,error:t.message||"Failed to update device config"},r.HttpStatus.INTERNAL_SERVER_ERROR)}}async getServiceStatus(){return{success:!0,data:{status:await this.deviceService.getServiceStatus()}}}async startService(){try{if(!await this.deviceService.hasActiveDevice())throw new r.HttpException({success:!1,error:"Vui lòng active bank trước khi start"},r.HttpStatus.BAD_REQUEST);return this.bankService.loginAllActiveBanks().catch(e=>{this.logger.error("Error during background login process: "+e.message)}),await new Promise(e=>setTimeout(e,2e3)),await this.deviceService.setServiceStatus("active"),{success:!0,message:"Service started successfully. Devices are logging in and will accept jobs when ready."}}catch(e){if(e instanceof r.HttpException)throw e;throw this.logger.error("Error starting service: "+e.message,e.stack),new r.HttpException({success:!1,error:e.message||"Failed to start service"},r.HttpStatus.INTERNAL_SERVER_ERROR)}}async stopService(){return await this.deviceService.setServiceStatus("inactive"),{success:!0,message:"Service stopped successfully"}}};exports.DeviceController=u,t([(0,r.Get)(),(0,r.Render)("devices"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],u.prototype,"getDevicesPage",null),t([(0,r.Get)("api/devices"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],u.prototype,"getDevices",null),t([(0,r.Get)("api/devices/:deviceId/config"),s(0,(0,r.Param)("deviceId")),i("design:type",Function),i("design:paramtypes",[String]),i("design:returntype",Promise)],u.prototype,"getDeviceConfig",null),t([(0,r.Post)("api/devices/:deviceId/retryLogin"),s(0,(0,r.Param)("deviceId")),i("design:type",Function),i("design:paramtypes",[String]),i("design:returntype",Promise)],u.prototype,"retryLogin",null),t([(0,r.Put)("api/devices/:deviceId/config"),s(0,(0,r.Param)("deviceId")),s(1,(0,r.Body)()),i("design:type",Function),i("design:paramtypes",[String,n.UpdateDeviceConfigDto]),i("design:returntype",Promise)],u.prototype,"updateDeviceConfig",null),t([(0,r.Get)("api/service/status"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],u.prototype,"getServiceStatus",null),t([(0,r.Post)("api/service/start"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],u.prototype,"startService",null),t([(0,r.Post)("api/service/stop"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",Promise)],u.prototype,"stopService",null),exports.DeviceController=u=e=t([(0,r.Controller)(),i("design:paramtypes",[c.DeviceService,a.BankService])],u);