"use strict";var t,e=this&&this.t||function(t,e,i,s){var r,c=arguments.length,a=3>c?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(r=t[n])&&(a=(3>c?r(a):c>3?r(e,i,a):r(e,i))||a);return c>3&&a&&Object.defineProperty(e,i,a),a},i=this&&this.i||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"o",{value:!0}),exports.DeviceService=void 0;const s=require("@nestjs/common"),r=require("../../common/services/redis.service"),c=require("../hcbox/hcbox.service");let a=t=class{constructor(e,i){this.redisService=e,this.hcBoxService=i,this.logger=new s.Logger(t.name),this.REDIS_DEVICE_CONFIG_PREFIX="device:",this.REDIS_DEVICE_CONFIG_SUFFIX=":config",this.REDIS_SERVICE_STATUS_KEY="service:status"}async onModuleInit(){try{await this.setServiceStatus("inactive"),this.logger.log("Service status initialized to: inactive")}catch(t){this.logger.error("Failed to initialize service status: "+t.message)}}async listDevices(){try{const t=await this.hcBoxService.listDevices();return await Promise.all(t.map(async t=>{const e=await this.getDeviceConfig(t.udid);return{...t,bankCode:e?.bankCode||"",availableAmount:e?.availableAmount||0,status:e?.status||"deactive",password:e?.password||"",smartOTP:e?.smartOTP||""}}))}catch(t){throw this.logger.error("Error listing devices: "+t.message),t}}async getDeviceConfig(t){try{const e=`${this.REDIS_DEVICE_CONFIG_PREFIX}${t}${this.REDIS_DEVICE_CONFIG_SUFFIX}`,i=await this.redisService.get(e);return i?JSON.parse(i):null}catch(e){return this.logger.error(`Error getting device config for ${t}: ${e.message}`),null}}async updateDeviceConfig(t,e){try{const i=`${this.REDIS_DEVICE_CONFIG_PREFIX}${t}${this.REDIS_DEVICE_CONFIG_SUFFIX}`,s=await this.getDeviceConfig(t),r={deviceId:t,bankCode:void 0!==e.bankCode?e.bankCode:s?.bankCode||"",availableAmount:void 0!==e.availableAmount?e.availableAmount:s?.availableAmount||0,status:void 0!==e.status?e.status:s?.status||"deactive",password:void 0!==e.password?e.password:s?.password||"",smartOTP:void 0!==e.smartOTP?e.smartOTP:s?.smartOTP||""};return await this.redisService.set(i,JSON.stringify(r)),this.logger.log(`Updated device config for ${t} (bankCode: ${r.bankCode||"not set"}): ${JSON.stringify(r)}`),r}catch(e){throw this.logger.error(`Error updating device config for ${t}: ${e.message}`),e}}async getServiceStatus(){try{return await this.redisService.get(this.REDIS_SERVICE_STATUS_KEY)||"inactive"}catch(t){return this.logger.error("Error getting service status: "+t.message),"inactive"}}async setServiceStatus(t){try{await this.redisService.set(this.REDIS_SERVICE_STATUS_KEY,t),this.logger.log("Service status set to: "+t)}catch(t){throw this.logger.error("Error setting service status: "+t.message),t}}async deductDeviceAmount(t,e){try{const i=await this.getDeviceConfig(t);if(!i)return!1;const s=i.availableAmount-e;return 0>s?(this.logger.warn(`Insufficient amount for device ${t}. Available: ${i.availableAmount}, Requested: ${e}`),!1):(await this.updateDeviceConfig(t,{availableAmount:s}),!0)}catch(e){return this.logger.error(`Error deducting amount for device ${t}: ${e.message}`),!1}}async hasActiveDevice(){try{return(await this.listDevices()).some(t=>"active"===t.status)}catch(t){return this.logger.error("Error checking active devices: "+t.message),!1}}};exports.DeviceService=a,exports.DeviceService=a=t=e([(0,s.Injectable)(),i("design:paramtypes",[r.RedisService,c.HcBoxService])],a);